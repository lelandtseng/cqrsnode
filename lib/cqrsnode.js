function c(e,t){this._data={name:e,data:t,aggreType:null,aggreId:null,time:new Date}}function p(e){function n(){var e=(new Date).getTime();for(var r in t._repoT)e-t._repoT[r]>1e4&&delete t._repo[r];setTimeout(n,1e4)}this._aggreType=e;var t=this;this._snapshotsDB=null,this._eventsDB=null,o("dbs/"+e.name+"_snapshots",function(e,n){t._snapshotsDB=n}),o("dbs/"+e.name+"_events",function(e,n){t._eventsDB=n}),this._repo={},this._repoT={},n()}function v(e){n.call(this),this._data={id:e,state:"LIVE"};var t=this;t.on("remove",function(){t._data.state="DEAD"})}function x(n,r){var i=t.resolve(g.mainPath+n),s=e.readdirSync(i);s.forEach(function(e){var n=t.basename(e,".js"),s=t.resolve(i+"/"+n);r[n]=require(s)})}function T(){var e={};for(var t in b)e[t]=a(b[t],v);module.exports.aggres=b=e}function N(){for(var e in w)f.on("",e,w[e])}function C(){this.cqrs=module.exports}function k(){for(var e in S){var t=a(S[e],C);t&&l.register(e,t)}}function L(){for(var e in b){var t=new p(b[e]);y[b[e].name]=t,b[e].prototype.repos=y}}var e=require("fs"),t=require("path"),n=require("events").EventEmitter,r=require("util"),i=require("lockmethod"),s=i.Position,o=require("tiny"),u=require("node-uuid"),a=require("node-extend"),f={emitter:new n,publish:function(t){this.emitter.emit(t.aggreType+t.aggreId+t.name,t),this.emitter.emit(t.aggreType+t.name,t),t.aggreType||this.emitter.emit(t.name,t)},on:function(t,n,r,i){arguments.length==4?t=t+n+r:arguments.length==3?(t+=n,i=r):i=n,this.emitter.on(t,i)},once:function(t,n,r,i){arguments.length==4?t=t+n+r:arguments.length==3?(t+=n,i=r):i=n,this.emitter.once(t,i)}},l={_repo:{},register:function(e,t){this._repo[e]=t},execute:function(e,t){this._repo[e.__proto__.constructor.name](e,t)}},h=c.prototype;h.__defineGetter__("aggreType",function(){return this._data.aggreType}),h.__defineGetter__("aggreId",function(){return this._data.aggreId}),h.__defineGetter__("time",function(){return this._data.time}),h.__defineGetter__("name",function(){return this._data.name}),h.__defineGetter__("data",function(){return this._data.data});var d=p.prototype;d.findById=i(new s(0),function(e,t){var n=this,r=t;this._repo[e]?(n._repoT[e]=(new Date).getTime(),t(this._repo[e])):this._snapshotsDB.find({}).desc("num").limit(1)(function(t,i){if(t||i.length==0)r(null);else{var s=i[0];n._eventsDB.find({snum:i[0].num})(function(t,i){var o=new n._aggreType(e);o._repository=n,o._loadSnapshot(s.data),o._loadEvents(i),n._repoT[e]=(new Date).getTime(),n._repo[e]=o,r(o)})}})}),d.create=function(e){var t=this,n=this._aggreType.create();n.id||(n._data.id=u.v4()),n._repository=t,t._repoT[n.id]=(new Date).getTime(),this._repo[n.id]=n,this._snapshotsDB.set(u.v1(),{aggreId:n.id,num:0,data:n._data},function(r){if(r)e(r);else{e(null,t._repo[n.id]);var i=new c("create",t._repo[n.id]._data);i._data.aggreType=t._aggreType.name,i._data.aggreId=n.id,t.publish(i,function(e){e()})}})},d.publish=i(new s(0,["_data","aggreId"]),function(e,t){var n=this;this._snapshotsDB.find({aggreId:e.aggreId}).desc("num").limit(1)(function(r,i){var s=i[0];n._eventsDB.find({snum:s.num}).desc("num").limit(1)(function(r,i){var o=0;i.length!=0&&(o=++i[0].num),n._eventsDB.set(u.v1(),{data:e._data,num:o,snum:s.num},function(r){o>10&&n._snapshotsDB.set(u.v1(),{aggreId:e.aggreId,num:s.num+1,data:n._repo[e.aggreId]._data},function(e){t()})})})}),f.publish(e)}),r.inherits(v,n);var m=v.prototype;m.__defineGetter__("id",function(){return this._data.id}),m.remove=function(){var e=new c("remove");this.publish(e)},m.publish=function(e){var t=new c(e[0],e[1]);this.emit(t.name,t.data),t._data.aggreType=this.constructor.name,t._data.aggreId=this.id,this._repository.publish(t,function(e){e()})},m._loadSnapshot=function(e){this._data=e},m._loadEvents=function(e){var t=this;e.forEach(function(e){var n=new c;n._data=e.data,t.emit(n.name,n.data)})};var g={mainPath:null},y={},b={},w={},E={},S={},A=!1;module.exports={init:function(e){A||(g=e,x("/aggres",b),T(),x("/eventHandles",w),x("/commands",E),x("/commandHandles",S),N(),k(),L(),A=!0)},Event:c,Aggre:v,commands:E,commandBus:l,repos:y};