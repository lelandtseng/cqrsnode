function l(e,t){this._data={name:e,data:t,aggreType:null,aggreId:null,time:new Date}}function h(e){this._aggreType=e;var t=this;this._snapshotsDB=null,this._eventsDB=null,o("dbs/"+e.name+"_snapshots",function(e,n){t._snapshotsDB=n}),o("dbs/"+e.name+"_events",function(e,n){t._eventsDB=n}),this._repo={}}function d(e){n.call(this),this._data={id:e,state:"LIVE"};var t=this;t.on("remove",function(){t._data.state="DEAD"})}function S(n,r){var i=t.resolve(m.mainPath+n),s=e.readdirSync(i);s.forEach(function(e){var n=t.basename(e,".js"),s=t.resolve(i+"/"+n);r[n]=require(s)})}function x(){for(var e in b)a.on("",e,b[e])}function T(){for(var e in w){var t=E[e+"Handle"];t&&f.register(e,t)}}function N(){for(var e in y){var t=new h(y[e]);g[y[e].name]=t}}var e=require("fs"),t=require("path"),n=require("events").EventEmitter,r=require("util"),i=require("lockmethod"),s=i.Position,o=require("tiny"),u=require("node-uuid"),a={emitter:new n,publish:function(t){this.emitter.emit(t.aggreType+t.aggreId+t.name,t),this.emitter.emit(t.aggreType+t.name,t),t.aggreType||this.emitter.emit(t.name,t)},on:function(t,n,r,i){arguments.length==4?t=t+n+r:arguments.length==3?(t+=n,i=r):i=n,this.emitter.on(t,i)},once:function(t,n,r,i){arguments.length==4?t=t+n+r:arguments.length==3?(t+=n,i=r):i=n,this.emitter.once(t,i)}},f={_repo:{},register:function(e,t){this._repo[e]=t},execute:function(e,t){this._repo[e.__proto__.constructor.name](e,t)}},c=l.prototype;c.__defineGetter__("aggreType",function(){return this._data.aggreType}),c.__defineGetter__("aggreId",function(){return this._data.aggreId}),c.__defineGetter__("time",function(){return this._data.time}),c.__defineGetter__("name",function(){return this._data.name}),c.__defineGetter__("data",function(){return this._data.data});var p=h.prototype;p.findById=i(new s(0),function(e,t){var n=this,r=t;this._repo[e]?t(this._repo[e]):this._snapshotsDB.find({}).desc("num").limit(1)(function(t,i){if(t||i.length==0)r(null);else{var s=i[0];n._eventsDB.find({snum:i[0].num})(function(t,i){var o=new n._aggreType(e);o._repository=n,o.loadSnapshot(s.data),o.loadEvents(i),n._repo[e]=o,r(o)})}})}),p.create=function(e){var t=this,n=this._aggreType.create();n._repository=t,this._repo[n.id]=n,this._snapshotsDB.set(u.v1(),{aggreId:n.id,num:0,data:n._data},function(r){if(r)e(r);else{e(null,t._repo[n.id]);var i=new l("create",t._repo[n.id]._data);i._data.aggreType=t._aggreType.name,i._data.aggreId=n.id,t.publish(i,function(e){e()})}})},p.publish=i(new s(0,["_data","aggreId"]),function(e,t){var n=this;this._snapshotsDB.find({aggreId:e.aggreId}).desc("num").limit(1)(function(r,i){var s=i[0];n._eventsDB.find({snum:0}).desc("num").limit(1)(function(r,i){var o=0;i.length!=0&&(o=++i[0].num),n._eventsDB.set(u.v1(),{data:e._data,num:o,snum:s.num},function(e){t()})})}),a.publish(e)}),r.inherits(d,n);var v=d.prototype;v.__defineGetter__("id",function(){return this._data.id}),v.remove=function(){var e=new l("remove");this.publish(e)},v.publish=function(e){this.emit(e.name,e.data),e._data.aggreType=this.constructor.name,e._data.aggreId=this.id,this._repository.publish(e,function(e){e()})},v.loadSnapshot=function(e){this._data=e},v.loadEvents=function(e){var t=this;e.forEach(function(e){var n=new l;n._data=e.data,t.emit(n.name,n.data)})};var m={mainPath:null},g={},y={},b={},w={},E={},C=!1;module.exports={init:function(e){C||(m=e,S("/aggres",y),S("/eventHandles",b),S("/commands",w),S("/commandHandles",E),x(),T(),N(),C=!0)},aggres:y,Event:l,Aggre:d,commands:w,commandBus:f,repos:g};